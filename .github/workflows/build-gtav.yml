name: Build GTA V Integration

on:
  push:
    branches: [ main, master, 'copilot/**' ]
    paths:
      - 'integrations/GTAV-ScriptHookV/**'
      - '.github/workflows/build-gtav.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'integrations/GTAV-ScriptHookV/**'
      - '.github/workflows/build-gtav.yml'
  workflow_dispatch:

jobs:
  build-gtav-script:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Download and Setup ScriptHook V SDK
      shell: powershell
      run: |
        # Download ScriptHook V SDK
        Write-Host "Downloading ScriptHook V SDK..."
        
        # Try multiple download methods
        $downloaded = $false
        
        # Method 1: Direct download
        try {
          $url = "http://www.dev-c.com/files/ScriptHookV_1.0.3351.0.zip"
          Invoke-WebRequest -Uri $url -OutFile "ScriptHookV_SDK.zip" -TimeoutSec 30 -UseBasicParsing
          $downloaded = $true
          Write-Host "Successfully downloaded ScriptHook V SDK"
        } catch {
          Write-Host "Method 1 failed: $_"
        }
        
        # Method 2: Alternative mirror (if available)
        if (-not $downloaded) {
          try {
            # Try archive.org or other mirrors if needed
            Write-Host "Trying alternative download method..."
            # For now, skip alternative
          } catch {
            Write-Host "Method 2 failed: $_"
          }
        }
        
        if ($downloaded) {
          # Extract SDK
          Write-Host "Extracting SDK..."
          Expand-Archive -Path "ScriptHookV_SDK.zip" -DestinationPath "ScriptHookV_SDK" -Force
          
          # List extracted files for debugging
          Write-Host "SDK Contents:"
          Get-ChildItem -Path "ScriptHookV_SDK" -Recurse | Select-Object FullName
          
          # Copy SDK files to project
          Write-Host "Copying SDK files to project..."
          
          # Try different possible SDK structures
          $sdkPaths = @("ScriptHookV_SDK/SDK", "ScriptHookV_SDK")
          
          foreach ($sdkPath in $sdkPaths) {
            if (Test-Path "$sdkPath/inc") {
              Write-Host "Found SDK at: $sdkPath"
              
              # Copy header files
              Copy-Item -Path "$sdkPath/inc/*" -Destination "integrations/GTAV-ScriptHookV/inc/" -Force
              Write-Host "Copied header files"
              
              # Create lib directory if needed
              if (-not (Test-Path "integrations/GTAV-ScriptHookV/lib")) {
                New-Item -Path "integrations/GTAV-ScriptHookV/lib" -ItemType Directory -Force
              }
              
              # Copy library file
              if (Test-Path "$sdkPath/lib/ScriptHookV.lib") {
                Copy-Item -Path "$sdkPath/lib/ScriptHookV.lib" -Destination "integrations/GTAV-ScriptHookV/lib/" -Force
                Write-Host "Copied library file"
              }
              
              break
            }
          }
        } else {
          Write-Host "::error::Failed to download ScriptHook V SDK"
          Write-Host "The build will create placeholder files only."
        }

    - name: Verify SDK Files
      shell: powershell
      run: |
        Write-Host "Checking SDK files..."
        Write-Host "`nHeader files in inc/:"
        Get-ChildItem -Path "integrations/GTAV-ScriptHookV/inc" -ErrorAction SilentlyContinue | Select-Object Name
        
        Write-Host "`nLibrary files in lib/:"
        Get-ChildItem -Path "integrations/GTAV-ScriptHookV/lib" -ErrorAction SilentlyContinue | Select-Object Name
        
        # Check if we have the actual SDK files
        $hasSDK = (Test-Path "integrations/GTAV-ScriptHookV/lib/ScriptHookV.lib")
        Write-Host "`nHas ScriptHookV.lib: $hasSDK"
        
        if ($hasSDK) {
          Write-Host "::notice::SDK files are present - real build will be attempted"
        } else {
          Write-Host "::warning::SDK files missing - placeholder will be created"
        }

    - name: Build GTA V Integration Script
      shell: powershell
      continue-on-error: true
      id: build
      run: |
        cd integrations/GTAV-ScriptHookV
        
        Write-Host "Starting build process..."
        
        # Check if we have the SDK library
        $hasSDK = Test-Path "lib/ScriptHookV.lib"
        
        if ($hasSDK) {
          Write-Host "Building MSAgentGTA.asi with actual SDK..."
          
          try {
            # Try to build
            msbuild MSAgentGTA.sln /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v143 /verbosity:minimal
            
            if (Test-Path "Release/MSAgentGTA.asi") {
              Write-Host "::notice::Build successful! ASI file created."
              Copy-Item -Path "Release/MSAgentGTA.asi" -Destination "../../MSAgentGTA.asi" -Force
              
              # Get file size
              $fileSize = (Get-Item "../../MSAgentGTA.asi").Length
              Write-Host "ASI file size: $fileSize bytes"
              
              echo "build_success=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "::error::Build completed but ASI file not found"
              echo "build_success=false" >> $env:GITHUB_OUTPUT
            }
          } catch {
            Write-Host "::error::Build failed with error: $_"
            echo "build_success=false" >> $env:GITHUB_OUTPUT
          }
        } else {
          Write-Host "::warning::SDK library not found - cannot build real ASI"
          echo "build_success=false" >> $env:GITHUB_OUTPUT
        }

    - name: Create Placeholder if Build Failed
      if: steps.build.outputs.build_success != 'true'
      shell: powershell
      run: |
        Write-Host "Creating placeholder ASI file..."
        
        $placeholderContent = @"
MSAgent-AI GTA V Integration - Build Placeholder
=================================================

This is a placeholder file because the actual build failed.

The ScriptHook V SDK could not be downloaded automatically due to:
- The download URL may be inaccessible
- Network restrictions
- SDK structure changes

To build the ASI manually:
1. Download ScriptHook V SDK from: http://www.dev-c.com/gtav/scripthookv/
2. Extract the SDK
3. Copy SDK/inc/* to integrations/GTAV-ScriptHookV/inc/
4. Copy SDK/lib/ScriptHookV.lib to integrations/GTAV-ScriptHookV/lib/
5. Open integrations/GTAV-ScriptHookV/MSAgentGTA.sln in Visual Studio
6. Build in Release x86 configuration

For more information, see the README.md in the GTAV-ScriptHookV folder.
"@
        
        $placeholderContent | Out-File -FilePath "MSAgentGTA.asi.txt" -Encoding UTF8
        Write-Host "::warning::Placeholder created - manual build required"

    - name: Create Build Info
      shell: powershell
      run: |
        $buildSuccess = "${{ steps.build.outputs.build_success }}" -eq "true"
        
        $buildInfo = @"
MSAgent-AI GTA V Integration Build
===================================

Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
Commit: $env:GITHUB_SHA
Branch: $env:GITHUB_REF_NAME
Build Status: $(if ($buildSuccess) { "SUCCESS - Real ASI file included" } else { "FAILED - Manual build required" })

"@

        if ($buildSuccess) {
          $buildInfo += @"

Installation Instructions:
1. Install ScriptHook V from http://www.dev-c.com/gtav/scripthookv/
2. Copy MSAgentGTA.asi to your GTA V directory (same folder as GTA5.exe)
3. Make sure MSAgent-AI is running
4. Launch GTA V
5. Press [ (left bracket) in-game to open the menu

"@
        } else {
          $buildInfo += @"

Manual Build Required:
The automated build could not download the ScriptHook V SDK.
Please build manually using Visual Studio:

1. Download ScriptHook V SDK from: http://www.dev-c.com/gtav/scripthookv/
2. Extract and copy SDK files:
   - SDK/inc/* → integrations/GTAV-ScriptHookV/inc/
   - SDK/lib/ScriptHookV.lib → integrations/GTAV-ScriptHookV/lib/
3. Open MSAgentGTA.sln in Visual Studio
4. Build in Release x86 configuration
5. The ASI file will be in Release/MSAgentGTA.asi

"@
        }

        $buildInfo += @"
For more information, see:
https://github.com/$env:GITHUB_REPOSITORY/tree/$env:GITHUB_REF_NAME/integrations/GTAV-ScriptHookV

Documentation:
- README.md - Complete guide
- QUICKSTART.md - Quick installation
- ARCHITECTURE.md - Technical details
"@
        
        $buildInfo | Out-File -FilePath "BUILD_INFO.txt" -Encoding UTF8

    - name: Upload Build Artifact (Success)
      if: steps.build.outputs.build_success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: MSAgentGTA-${{ github.sha }}
        path: |
          MSAgentGTA.asi
          BUILD_INFO.txt
          integrations/GTAV-ScriptHookV/README.md
          integrations/GTAV-ScriptHookV/QUICKSTART.md
        retention-days: 90

    - name: Upload Build Artifact (Failed - Placeholder)
      if: steps.build.outputs.build_success != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: MSAgentGTA-BuildInstructions-${{ github.sha }}
        path: |
          MSAgentGTA.asi.txt
          BUILD_INFO.txt
          integrations/GTAV-ScriptHookV/README.md
          integrations/GTAV-ScriptHookV/QUICKSTART.md
          integrations/GTAV-ScriptHookV/MSAgentGTA.sln
          integrations/GTAV-ScriptHookV/MSAgentGTA.vcxproj
          integrations/GTAV-ScriptHookV/script.cpp
          integrations/GTAV-ScriptHookV/keyboard.h
          integrations/GTAV-ScriptHookV/exports.def
        retention-days: 90

    - name: Build Summary
      shell: powershell
      run: |
        $buildSuccess = "${{ steps.build.outputs.build_success }}" -eq "true"
        
        Write-Host "========================================="
        Write-Host "GTA V Integration Build Complete!"
        Write-Host "========================================="
        Write-Host ""
        
        if ($buildSuccess) {
          Write-Host "✓ SUCCESS: Compiled ASI file is ready!" -ForegroundColor Green
          Write-Host ""
          Write-Host "Download the artifact 'MSAgentGTA-$env:GITHUB_SHA' from the Actions tab"
          Write-Host ""
          Write-Host "The artifact contains:"
          Write-Host "  - MSAgentGTA.asi (the compiled script)"
          Write-Host "  - BUILD_INFO.txt (installation instructions)"
          Write-Host "  - Documentation files"
        } else {
          Write-Host "⚠ WARNING: Build failed - manual compilation required" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "Download 'MSAgentGTA-BuildInstructions-$env:GITHUB_SHA' for:"
          Write-Host "  - Build instructions"
          Write-Host "  - Source files ready for Visual Studio"
          Write-Host "  - Documentation"
          Write-Host ""
          Write-Host "The ScriptHook V SDK must be downloaded separately"
          Write-Host "from: http://www.dev-c.com/gtav/scripthookv/"
        }

